// Cartesia Voice Service - Sonic 3.0 Voice Library

// SONIC 3.0 VOICE LIBRARY - All IDs verified working
export const CARTESIA_VOICE_LIBRARY = {
  // â”€â”€ NARRATORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  'narrator_male_kyle': {
    id: 'c961b81c-a935-4c17-bfb3-ba2239de8c2f',
    name: 'Kyle',
    gender: 'male',
    style: 'narrator',
    description: 'Approachable narrator voice',
    tags: ['narrator', 'storyteller', 'engaging'],
    preview_url: 'https://play.cartesia.ai/voices/c961b81c-a935-4c17-bfb3-ba2239de8c2f'
  },
  'narrator_male_rupert': {
    id: '0ad65e7f-006c-47cf-bd31-52279d487913',
    name: 'Rupert',
    gender: 'male',
    style: 'narrator',
    description: 'Caring Dad - British',
    tags: ['narrator', 'british', 'warm', 'mature'],
    preview_url: 'https://play.cartesia.ai/voices/0ad65e7f-006c-47cf-bd31-52279d487913'
  },
  'narrator_female_marian': {
    id: '26403c37-80c1-4a1a-8692-540551ca2ae5',
    name: 'Marian',
    gender: 'female',
    style: 'narrator',
    description: 'Poised narrator - calm authority',
    tags: ['narrator', 'storyteller', 'mature', 'calm'],
    preview_url: 'https://play.cartesia.ai/voices/26403c37-80c1-4a1a-8692-540551ca2ae5'
  },
  'narrator_male_theo': {
    id: '79f8b5fb-2cc8-479a-80df-29f7a7cf1a3e',
    name: 'Theo',
    gender: 'male',
    style: 'narrator',
    description: 'Modern narrator - steady and confident',
    tags: ['narrator', 'modern', 'confident'],
    preview_url: 'https://play.cartesia.ai/voices/79f8b5fb-2cc8-479a-80df-29f7a7cf1a3e'
  },
  'narrator_female_robyn': {
    id: '8985388c-1332-4ce7-8d55-789628aa3df4',
    name: 'Robyn',
    gender: 'female',
    style: 'narrator',
    description: 'Storycrafter - Australian, neutral and mature',
    tags: ['narrator', 'australian', 'mature', 'neutral'],
    preview_url: 'https://play.cartesia.ai/voices/8985388c-1332-4ce7-8d55-789628aa3df4'
  },

  // â”€â”€ MALE CHARACTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  'male_hugo': {
    id: '1463a4e1-56a1-4b41-b257-728d56e93605',
    name: 'Hugo',
    gender: 'male',
    style: 'character',
    description: 'Friendly male voice - British',
    tags: ['character', 'british', 'expressive', 'friendly'],
    preview_url: 'https://play.cartesia.ai/voices/1463a4e1-56a1-4b41-b257-728d56e93605'
  },
  'male_carson': {
    id: '86e30c1d-714b-4074-a1f2-1cb6b552fb49',
    name: 'Carson',
    gender: 'male',
    style: 'character',
    description: 'Curious Conversationalist - friendly young adult',
    tags: ['character', 'curious', 'friendly', 'young'],
    preview_url: 'https://play.cartesia.ai/voices/86e30c1d-714b-4074-a1f2-1cb6b552fb49'
  },
  'male_henry': {
    id: '87286a8d-7ea7-4235-a41a-dd9fa6630feb',
    name: 'Henry',
    gender: 'male',
    style: 'character',
    description: 'Plainspoken Guy - relaxed, matter-of-fact',
    tags: ['character', 'casual', 'monotone', 'relaxed'],
    preview_url: 'https://play.cartesia.ai/voices/87286a8d-7ea7-4235-a41a-dd9fa6630feb'
  },
  'male_blake': {
    id: 'a167e0f3-df7e-4d52-a9c3-f949145efdab',
    name: 'Blake',
    gender: 'male',
    style: 'character',
    description: 'Helpful Friend - energetic adult male',
    tags: ['character', 'energetic', 'friendly'],
    preview_url: 'https://play.cartesia.ai/voices/a167e0f3-df7e-4d52-a9c3-f949145efdab'
  },
  'male_oliver': {
    id: 'ee7ea9f8-c0c1-498c-9279-764d6b56d189',
    name: 'Oliver',
    gender: 'male',
    style: 'character',
    description: 'Polite young adult - British',
    tags: ['character', 'british', 'polite', 'young'],
    preview_url: 'https://play.cartesia.ai/voices/ee7ea9f8-c0c1-498c-9279-764d6b56d189'
  },
  'male_jeremy': {
    id: '6cb8801d-259a-4bdc-978f-b45808d58cd3',
    name: 'Jeremy',
    gender: 'male',
    style: 'character',
    description: 'Energetic Young Male - high energy, engaging',
    tags: ['character', 'energetic', 'young', 'upbeat'],
    preview_url: 'https://play.cartesia.ai/voices/6cb8801d-259a-4bdc-978f-b45808d58cd3'
  },

  // â”€â”€ YOUNG MALE CHARACTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  'young_male_jake': {
    id: '729651dc-c6c3-4ee5-97fa-350da1f88600',
    name: 'Jake',
    gender: 'male',
    style: 'youthful',
    description: 'Friendly Young Male - welcoming and engaging',
    tags: ['young', 'friendly', 'character'],
    preview_url: 'https://play.cartesia.ai/voices/729651dc-c6c3-4ee5-97fa-350da1f88600'
  },
  'young_male_zeke': {
    id: 'e00d0e4c-a5c8-443f-a8a3-473eb9a62355',
    name: 'Zeke',
    gender: 'male',
    style: 'youthful',
    description: 'Friendly high-pitched Young Male - gaming and entertainment',
    tags: ['young', 'high-pitched', 'character', 'gaming'],
    preview_url: 'https://play.cartesia.ai/voices/e00d0e4c-a5c8-443f-a8a3-473eb9a62355'
  },

  // â”€â”€ FEMALE CHARACTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  'female_tessa': {
    id: '6ccbfb76-1fc6-48f7-b71d-91ac6298247b',
    name: 'Tessa',
    gender: 'female',
    style: 'warm',
    description: 'Kind Companion - warm and conversational',
    tags: ['character', 'warm', 'friendly', 'protagonist'],
    preview_url: 'https://play.cartesia.ai/voices/6ccbfb76-1fc6-48f7-b71d-91ac6298247b'
  },
  'female_kira': {
    id: '57dcab65-68ac-45a6-8480-6c4c52ec1cd1',
    name: 'Kira',
    gender: 'female',
    style: 'warm',
    description: 'Trusted Confidant - emotive young adult',
    tags: ['character', 'emotive', 'warm', 'protagonist'],
    preview_url: 'https://play.cartesia.ai/voices/57dcab65-68ac-45a6-8480-6c4c52ec1cd1'
  },
  'female_charlotte': {
    id: '71a7ad14-091c-4e8e-a314-022ece01c121',
    name: 'Charlotte',
    gender: 'female',
    style: 'character',
    description: 'Heiress - elegant young adult, British',
    tags: ['character', 'british', 'elegant', 'protagonist'],
    preview_url: 'https://play.cartesia.ai/voices/71a7ad14-091c-4e8e-a314-022ece01c121'
  },
  'female_olivia': {
    id: 'f31cc6a7-c1e8-4764-980c-60a361443dd1',
    name: 'Olivia',
    gender: 'female',
    style: 'warm',
    description: 'Sunny Woman - friendly, happy adult, Australian',
    tags: ['character', 'australian', 'friendly', 'warm'],
    preview_url: 'https://play.cartesia.ai/voices/f31cc6a7-c1e8-4764-980c-60a361443dd1'
  },
  'female_madison': {
    id: 'a5def41e-2e73-433f-92f7-5f1d99fef05d',
    name: 'Madison',
    gender: 'female',
    style: 'character',
    description: 'Best Friend - enthusiastic young adult',
    tags: ['character', 'enthusiastic', 'young', 'emotive'],
    preview_url: 'https://play.cartesia.ai/voices/a5def41e-2e73-433f-92f7-5f1d99fef05d'
  },
  'female_katie': {
    id: 'f786b574-daa5-4673-aa0c-cbe3e8534c02',
    name: 'Katie',
    gender: 'female',
    style: 'character',
    description: 'Friendly Fixer - enunciating young adult',
    tags: ['character', 'clear', 'friendly', 'young'],
    preview_url: 'https://play.cartesia.ai/voices/f786b574-daa5-4673-aa0c-cbe3e8534c02'
  },
  'female_avery': {
    id: 'cccc21e8-5bcf-4ff0-bc7f-be4e40afc544',
    name: 'Avery',
    gender: 'female',
    style: 'youthful',
    description: 'Gaming Girl - high-pitched, energetic',
    tags: ['character', 'energetic', 'high-pitched', 'gaming'],
    preview_url: 'https://play.cartesia.ai/voices/cccc21e8-5bcf-4ff0-bc7f-be4e40afc544'
  },

  // â”€â”€ YOUNG FEMALE CHARACTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  'young_female_daisy': {
    id: '32b3f3c5-7171-46aa-abe7-b598964aa793',
    name: 'Daisy',
    gender: 'female',
    style: 'youthful',
    description: 'Young Main Character - children\'s book narrations',
    tags: ['young', 'bright', 'cheerful', 'protagonist'],
    preview_url: 'https://play.cartesia.ai/voices/32b3f3c5-7171-46aa-abe7-b598964aa793'
  },
  'young_female_dottie': {
    id: 'e3827ec5-697a-4b7c-9704-1a23041bbc51',
    name: 'Dottie',
    gender: 'female',
    style: 'youthful',
    description: 'Sweet Main Character - earnest, very young female',
    tags: ['young', 'sweet', 'earnest', 'protagonist'],
    preview_url: 'https://play.cartesia.ai/voices/e3827ec5-697a-4b7c-9704-1a23041bbc51'
  },
  'young_female_lexi': {
    id: '56b87df1-594d-4135-992c-1112bb504c59',
    name: 'Lexi',
    gender: 'female',
    style: 'youthful',
    description: 'Fun Friend - cheery young female',
    tags: ['young', 'cheery', 'fun', 'character'],
    preview_url: 'https://play.cartesia.ai/voices/56b87df1-594d-4135-992c-1112bb504c59'
  },

  // â”€â”€ SPECIAL / ACCENT CHARACTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  'special_male_fran': {
    id: '79743797-2087-422f-8dc7-86f9efca85f1',
    name: 'Fran',
    gender: 'male',
    style: 'character',
    description: 'Confident Young Character - Spanish accent',
    tags: ['character', 'spanish', 'accent', 'unique'],
    preview_url: 'https://play.cartesia.ai/voices/79743797-2087-422f-8dc7-86f9efca85f1'
  },
  'special_male_joey': {
    id: '34575e71-908f-4ab6-ab54-b08c95d6597d',
    name: 'Joey',
    gender: 'male',
    style: 'character',
    description: 'Neighborhood Guy - casual and friendly',
    tags: ['character', 'casual', 'friendly', 'unique'],
    preview_url: 'https://play.cartesia.ai/voices/34575e71-908f-4ab6-ab54-b08c95d6597d'
  },
  'special_female_lulu': {
    id: 'e13cae5c-ec59-4f71-b0a6-266df3c9bb8e',
    name: 'Lulu',
    gender: 'female',
    style: 'character',
    description: 'Madame Mischief - squeaky, kids entertainment',
    tags: ['character', 'quirky', 'squeaky', 'unique'],
    preview_url: 'https://play.cartesia.ai/voices/e13cae5c-ec59-4f71-b0a6-266df3c9bb8e'
  },
  'special_male_matt': {
    id: 'bfd3644b-d561-4b1c-a01f-d9af98cb67c0',
    name: 'Matt',
    gender: 'male',
    style: 'character',
    description: 'Goofy Friend - high-pitched, silly',
    tags: ['character', 'silly', 'goofy', 'unique'],
    preview_url: 'https://play.cartesia.ai/voices/bfd3644b-d561-4b1c-a01f-d9af98cb67c0'
  },
  'special_male_caspian': {
    id: 'd7862948-75c3-4c7c-ae28-2959fe166f49',
    name: 'Caspian',
    gender: 'male',
    style: 'character',
    description: 'Oracle - echo-y, mystical, gravitas',
    tags: ['character', 'mystical', 'deep', 'unique'],
    preview_url: 'https://play.cartesia.ai/voices/d7862948-75c3-4c7c-ae28-2959fe166f49'
  }
};

// Helper Functions
export function getAllVoices() {
  return Object.values(CARTESIA_VOICE_LIBRARY);
}

export function getVoicesByFilter(filter = {}) {
  const voices = getAllVoices();
  
  if (!filter || Object.keys(filter).length === 0) {
    return voices;
  }
  
  return voices.filter(voice => {
    if (filter.gender && voice.gender !== filter.gender) return false;
    if (filter.style && voice.style !== filter.style) return false;
    if (filter.tags && !filter.tags.some(tag => voice.tags.includes(tag))) return false;
    return true;
  });
}

export function getVoiceById(voiceId) {
  return getAllVoices().find(voice => voice.id === voiceId);
}

export function getVoiceName(voiceId) {
  const voice = getVoiceById(voiceId);
  return voice ? voice.name : 'Unknown Voice';
}

// Voice Assignment API Functions
export async function getVoiceAssignments(scriptId, userId) {
  try {
    // Query by script_id since that's what we have in the UI
    const response = await fetch(import.meta.env.VITE_N8N_GET_VOICE_ASSIGNMENTS_WEBHOOK, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        script_id: scriptId,
        user_id: userId
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    // Check if response has content before parsing JSON
    const responseText = await response.text();
    console.log('ðŸ” Get voice assignments raw response:', responseText);
    
    if (!responseText || responseText.trim() === '') {
      console.log('Empty response from voice assignments API, returning empty assignments');
      return {};
    }

    let result;
    try {
      result = JSON.parse(responseText);
      console.log('ðŸ” Parsed get voice assignments result:', result);
    } catch (parseError) {
      console.error('Failed to parse JSON response:', parseError);
      console.error('Response text:', responseText);
      return {};
    }
    
    const assignments = {};

    // Unwrap "object Object" key (n8n array-wrap artefact) then normalise
    if (result && result['object Object']) {
      result = result['object Object'];
    } else if (Array.isArray(result) && result.length > 0) {
      result = result[0];
    }

    // Now parse the unwrapped result
    if (result && result.data && Array.isArray(result.data.assignments)) {
      console.log('ðŸ” Using data.assignments format for get response');
      result.data.assignments.forEach(assignment => {
        assignments[assignment.character_name] = assignment.cartesia_voice_id;
      });
    } else if (result && result.assignments && Array.isArray(result.assignments)) {
      console.log('ðŸ” Using assignments array format for get response');
      result.assignments.forEach(assignment => {
        assignments[assignment.character_name] = assignment.cartesia_voice_id;
      });
    } else if (result && Array.isArray(result)) {
      console.log('ðŸ” Using direct array format for get response');
      result.forEach(assignment => {
        assignments[assignment.character_name] = assignment.cartesia_voice_id;
      });
    } else {
      console.warn('ðŸ” Unknown get voice assignments response format:', result ? Object.keys(result) : result);
    }
    
    console.log('ðŸ” Final converted assignments:', assignments);
    
    return assignments;
  } catch (error) {
    console.error('Error getting voice assignments:', error);
    console.error('Full error details:', error.message);
    return {};
  }
}

export async function saveVoiceAssignments(scriptId, assignments, userId, productionId = null) {
  try {
    // Convert assignments to match your schema
    const formattedAssignments = Object.entries(assignments).map(([characterName, voiceId]) => ({
      script_id: scriptId,
      production_id: productionId, // Include production_id for RLS
      character_name: characterName,
      cartesia_voice_id: voiceId, // Using your schema field name
      voice_name: getVoiceById(voiceId)?.name || 'Unknown Voice',
      voice_settings: {},
      emotion_mappings: {},
      default_emotion: 'neutral'
    }));

    const payload = {
      script_id: scriptId,
      production_id: productionId,
      assignments: formattedAssignments,
      user_id: userId
    };
    
    console.log('ðŸ’¾ Sending save request:', JSON.stringify(payload, null, 2));
    console.log('ðŸ“¡ Webhook URL:', import.meta.env.VITE_N8N_SAVE_VOICE_ASSIGNMENTS_WEBHOOK);

    const response = await fetch(import.meta.env.VITE_N8N_SAVE_VOICE_ASSIGNMENTS_WEBHOOK, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    // Check if response has content before parsing JSON
    const responseText = await response.text();
    console.log('Save response text:', responseText);
    
    if (!responseText) {
      console.log('Empty response from save webhook');
      return { success: true, message: 'Voice assignments saved successfully' };
    }
    
    const result = JSON.parse(responseText);
    console.log('Save response:', result);
    
    // Handle malformed response with "object Object" key
    if (result['object Object']) {
      console.log('Using object Object key for save response');
      return result['object Object'];
    }
    
    return result;
  } catch (error) {
    console.error('Error saving voice assignments:', error);
    console.error('Full error details:', error.message);
    throw error;
  }
}

export async function previewVoiceOnLine(voiceId, text, characterName, userId, scriptId) {
  try {
    const response = await fetch(import.meta.env.VITE_N8N_LINE_PREVIEW_WEBHOOK, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        line_data: {
          text,
          speaker: characterName
        },
        voice_id: voiceId,
        user_id: userId,
        script_id: scriptId,
        line_id: 'preview-line'
      })
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const result = await response.json();
    return result;
  } catch (error) {
    console.error('Error previewing voice:', error);
    return {
      success: false,
      error: error.message
    };
  }
}

export async function autoAssignVoices(scriptId, userId, characters = []) {
  try {
    console.log('ðŸŽ­ Auto-assign called with characters:', characters);
    
    const voiceLibrary = getAllVoices().map(v => ({
      id: v.id,
      name: v.name,
      gender: v.gender,
      style: v.style,
      description: v.description,
      tags: v.tags
    }));

    const payload = {
      script_id: scriptId,
      user_id: userId,
      characters: characters,
      voice_library: voiceLibrary
    };
    
    console.log('ðŸ” Auto-assign payload being sent:', JSON.stringify(payload, null, 2));
    console.log('ðŸ” Auto-assign webhook URL:', import.meta.env.VITE_N8N_AUTO_ASSIGN_VOICES_WEBHOOK);
    
    const response = await fetch(import.meta.env.VITE_N8N_AUTO_ASSIGN_VOICES_WEBHOOK, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    // Handle empty response like other functions
    const responseText = await response.text();
    console.log('ðŸ” Auto-assign raw response:', responseText);
    
    if (!responseText || responseText.trim() === '') {
      console.log('Empty response from auto-assign API');
      return { success: false, error: 'Empty response from server' };
    }

    let result;
    try {
      result = JSON.parse(responseText);
      console.log('ðŸ” Auto-assign parsed result:', result);
    } catch (parseError) {
      console.error('Failed to parse auto-assign JSON response:', parseError);
      console.error('Response text:', responseText);
      return { success: false, error: 'Invalid JSON response from server' };
    }

    // Unwrap "object Object" key if n8n returns array-wrapped response
    if (result && result['object Object']) {
      result = result['object Object'];
    } else if (Array.isArray(result) && result.length > 0) {
      result = result[0];
    }
    
    return result;
  } catch (error) {
    console.error('Error auto-assigning voices:', error);
    return {
      success: false,
      error: error.message
    };
  }
}

